---
title: "AGC ML"
author: "Chris Nieters"
date: Sys.Date()
editor_options:
  chunk_output_type: console
format:
  html:
    code-fold: false
    embed-resources: true
    toc: true
    number-sections: false
    theme: cerulean
---

```{r setup}
#| warning: false
#| message: false
#| echo: false

### Load libraries
library(tidyverse)
library(googlesheets4)
library(ggpubr)
library(ggsci)
library(car)
library(broom) # for model residuals extraction
library(broom.mixed)
library(emmeans) # for model mean extraction
library(multcomp)
library(nlme)
library(readxl)
library(lubridate)
library(hms)
library(tidymodels)


```

# data import
```{r}

simb_data <- read_xlsx("../data/simb_data.xlsx")

sima_data <- read_csv("../data/sima_data.csv",
                      show_col_types = F)

```

## wrangle data
```{r}

#convert date objects - issue losing one data point/day at midnight
simb_dataw <- simb_data |>
  mutate(
    excel_time = as.numeric(.data$`DateTime (Excel)`) ,
    datetime = lubridate::ymd_hms(
      openxlsx::convertToDateTime(
        .data$excel_time,
        origin = "1900-01-01")),
    date = as_date(datetime),
    start_date = as_date("2023-01-15"),
    dat = date - start_date)|>
  janitor::clean_names()|>
  rename_with(~str_remove(.x, "comp1."))|>
  dplyr::select(-date_time_formatted,
                -date_time_excel,
                -excel_time,
                -start_date)|>
  mutate(sim = "Sim B")|>
  dplyr::select(sim,date,datetime,dat,everything())


#format b data long
simbw_long <- simb_dataw |>
  pivot_longer(
    -c(1:4),
    names_to = "metric")
    


#convert date objects - issue losing one data point/day at midnight
sima_dataw <- sima_data |>
  mutate(
    excel_time = as.numeric(.data$`Excel DateTime`) ,
    datetime = lubridate::ymd_hms(
      openxlsx::convertToDateTime(
        .data$excel_time,
        origin = "1900-01-01")),
    date = as_date(datetime),
    start_date = as_date("2023-09-05"),
    dat = date - start_date)|>
  janitor::clean_names()|>
  rename_with(~str_remove(.x, "comp1."))|>
  dplyr::select(-date_time_converted,
                -excel_date_time,
                -excel_time,
                -start_date)|>
  mutate(sim = "Sim A")|>
  dplyr::select(sim,date,datetime,dat,everything())



#format a data long
simaw_long <- sima_dataw |>
  pivot_longer(
    -c(1:4),
    names_to = "metric")



```

##combine simulator a and b data
```{r}

#wide format
combined <- sima_dataw |>
  full_join(simb_dataw)


#long format
combined_long <- simaw_long |>
  full_join(simbw_long)


```


##calc variable costs
```{r}

var_costs <- combined |>
  mutate(
    light_cost = case_when(
      common_elec_price_peak_hour_bool  > 0.5 ~ lmp1_elec_use_w_m2/1000*0.3,
      common_elec_price_peak_hour_bool <= 0.5 ~ lmp1_elec_use_w_m2/1000*0.2),
    heat_cost = p_con_pipe1_value_w_m2/1000*0.09,
    co2_cost = mc_pure_air_value_kg_m2_s*3600) |>
 dplyr::select(sim,datetime,light_cost,heat_cost,co2_cost)|>
  pivot_longer(-c(1:2))


var_costs |>
  ggplot(aes(x = datetime, y = value,
             color = name))+
  geom_point(alpha = 0.1)+
  geom_smooth()+
  facet_grid(name~sim, scales = "free")


ggsave("../output/variable_costs.tiff",
       dpi = 350,
       height = 8,
       width = 12)

```


## crop development
```{r}

combined_long |>
  filter(metric %in% c("growth_crop_abs_0_1",
                       "growth_dv_sfruit_0_1",
                       #"growth_fruit_freshweight_gram_plant_1",
                       "growth_dry_matter_fract_0_1"))|>
                       #"growth_plant_density_plants_m_2"))|>
  ggplot(aes(x = dat,
             y = value,
             color = metric))+
  geom_point()+
  geom_smooth()+
  facet_wrap(~sim, scales = "free")+
  theme(legend.position = "top")+
  geom_vline(aes(xintercept = as_date(25)),
                 color = "black",
                 linetype = "dashed")+
  annotate("text",x = 18, y = 0.9,
                label = "25 DAT",
            color = "black")+
  xlab("Days After Transplant")

#save output to folder
ggsave("../output/growth_stages.tiff",
       dpi = 350,
       height = 6,
       width = 10)


```

## key features x dat
```{r}


#filter and plot metrics
combined_long |>
  filter(metric %in% c("growth_crop_abs_0_1",
                       "growth_dv_sfruit_0_1",
                       "growth_fruit_freshweight_gram_plant_1",
                       "growth_dry_matter_fract_0_1",
                       "growth_plant_density_plants_m_2"))|>
  ggplot(aes(x = dat,
             y = value,
             color = metric))+
  geom_point()+
  geom_smooth()+
  facet_grid(metric~sim, scales = "free")+
  theme(legend.position = "none",
        panel.spacing = unit(2, "lines"),
        strip.text.y = element_text(angle = 0))+
  geom_vline(aes(xintercept = as_date(25)),
                 color = "black",
                 linetype = "dashed")+
  annotate("text",x = 18, y = 0.9,
                label = "25 DAT",
            color = "black")+
  xlab("Days After Transplant")


#save output to folder
ggsave("../output/key_dat.tiff",
       dpi = 350,
       height = 8,
       width = 12)


```
